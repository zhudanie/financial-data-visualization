---
title: "CSC324 Individual Project"
author: "Daniel Zhu"
date: "2/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library-setup}
library(tidyverse)
library(readxl)
library(dplyr)
library(fs)
library(readr)
library(shiny)
```


```{r merge-datasets}
file_paths <- fs::dir_ls("stock_data")
file_paths

# Setting up the master file
composite <- read_excel(file_paths[1])

# Drop information that is not needed (doesn't change day-to-day)
composite <- composite[-c(3:19, 76, 42:73)] %>% filter(composite$Ticker == "AAPL")
colnames(composite)[1] <- c("Date")

# Loop through directory to merge all August dates
for (i in seq_along(file_paths)[-1]) {
  df1 <- read_excel(file_paths[i]) 
  df1 <- df1[-c(3:19, 76, 42:73)] %>%
    filter(df1$Ticker == "AAPL")
  colnames(df1)[1] <- c("Date")
  composite <- full_join(composite, df1)
}

# Set up vector to iterate through
columns <- colnames(composite)[3:35]

# Iterate through each column to find the difference day-to-day and create a new column
for (col in columns){
  composite[, col] <- as.numeric(unlist(composite[, col]))
  for(row in 2:nrow(composite)){
      composite[row, paste0(col, "_diff")] <- composite[row, col] - composite[row - 1, col]
  }
}

# Save file
write_csv(composite, "compositeAugust.csv")
```

```{r complete-regression}
compositeAugust <- as.data.frame(read_csv("compositeAugust_5daylag.csv"))
compositeAugust$Date <- NULL

ui <- fluidPage(
  titlePanel("Regression Model (Dataset: compositeAugust)"),
  sidebarLayout(
    sidebarPanel(
      selectInput("outcome", label = h3("Outcome"),
                  choices = list("SMA20" = "SMA20",
                                 "Price" = "Price",
                                 "ATR" = "ATR",
                                 "SMA20_diff" = "SMA20_diff",
                                 "Price_diff" = "Price_diff",
                                 "ATR_diff" = "ATR_diff"), selected = 1),

      selectInput("indepvar", label = h3("Explanatory variable"),
                  choices = list("SMA20" = "SMA20",
                                 "Price" = "Price",
                                 "ATR" = "ATR",
                                 "SMA20_diff" = "SMA20_diff",
                                 "Price_diff" = "Price_diff",
                                 "ATR_diff" = "ATR_diff"), selected = 1)

    ),

    mainPanel(

      tabsetPanel(type = "tabs",

tabPanel("Scatterplot", plotOutput("scatterplot")), # Plot
tabPanel("Distribution", # Plots of distributions
         fluidRow(
           column(6, plotOutput("distribution1")),
           column(6, plotOutput("distribution2")))
         ),
tabPanel("Model Summary", verbatimTextOutput("summary")), # Regression output
tabPanel("Data", DT::dataTableOutput('tbl')) # Data as datatable

      )
    )
    ))



# SERVER
server <- function(input, output) {

  # Regression output
  output$summary <- renderPrint({
    fit <- lm(compositeAugust[,input$outcome] ~ compositeAugust[,input$indepvar])
    names(fit$coefficients) <- c("Intercept", input$var2)
    summary(fit)
  })

  # Data output
  output$tbl = DT::renderDataTable({
    DT::datatable(compositeAugust, options = list(lengthChange = FALSE))
  })

  
  # Scatterplot output
  output$scatterplot <- renderPlot({
    plot(compositeAugust[,input$indepvar], compositeAugust[,input$outcome], main="Scatterplot",
         xlab=input$indepvar, ylab=input$outcome, pch=19)
    abline(lm(compositeAugust[,input$outcome] ~ compositeAugust[,input$indepvar]), col="red")
    lines(lowess(compositeAugust[,input$indepvar],compositeAugust[,input$outcome]), col="blue")
  }, height=400)

  
  # Histogram output var 1
  output$distribution1 <- renderPlot({
    hist(compositeAugust[,input$outcome], main="", xlab=input$outcome)
  }, height=300, width=300)

  # Histogram output var 2
  output$distribution2 <- renderPlot({
    hist(compositeAugust[,input$indepvar], main="", xlab=input$indepvar)
  }, height=300, width=300)
}

shinyApp(ui = ui, server = server)

```



